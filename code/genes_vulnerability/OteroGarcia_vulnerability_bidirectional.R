#################
### Load data ###
#################

rm(list=setdiff(ls(),c('params','grp','injection.site')))
print(grp)
basedir <- params$basedir
setwd(basedir)
savedir <- paste(params$opdir,'genes_vulnerability/',paste0(injection.site,collapse='-'),'/',sep='')
dir.create(savedir,recursive=T)

source('code/misc/fitfxns.R')
source('code/misc/optimfxns.R')
source('code/misc/miscfxns.R')
source('code/misc/plottingfxns.R')
load(paste(params$opdir,'processed/pathdata.RData',sep=''))  # load path data and ROI names

##########################
### load vulnerability ###
##########################

vuln.dir <- paste(params$opdir,'diffmodel/bidirectional_onelm/',paste0(injection.site,collapse='-'),'/',sep='')
# compute intrinsic vulnerability as an average over time and hemispheres
tp.excl <- '1 MPI' # exclude 1 MPI - see diffmodel/vuln_hemi_time.R
df.vuln <- read.csv(paste0(vuln.dir,grp,'vulnerability_bidirectional_hemiaverage_exclude',tp.excl,'.csv'),row.names = 1)

#################################
### load gene expression data ###
#################################

df.gene <- read.csv('data/aba/expression/AllGeneExpression_Fulcher2019.csv',row.names = 1)

# convert hemisphere averaged gene expression to CNDR space
rownames(df.gene) <- paste0('i',rownames(df.gene)) # add i so mapping function works
df.gene.CNDR <- map.ABA.to.CNDR(df.gene,path.names,ABA.to.CNDR.key)
df.gene.CNDR <- df.gene.CNDR[paste0('i',rownames(df.vuln)),] # remove contra regions which are all na and order like vulnerability
rownames(df.gene.CNDR) <- rownames(df.vuln) # remove i from names

#df.gene.CNDR <- df.gene.CNDR[,-which(colSums(is.na(df.gene.CNDR)) > 0.1*nrow(df.gene.CNDR))]
gene.names <- colnames(df.gene.CNDR)
names(gene.names) <- gene.names

### only analyze genes that are more highly expressed in NFT+ neurons ###
# https://www.biorxiv.org/content/10.1101/2020.05.11.088591v1.full.pdf
gene.list <- read.csv('data/TauVulnGOI.csv',header=F,stringsAsFactors = F)
gene.list <- setNames(as.list(gene.list$V1),gene.list$V1)
gene.list <- gene.list[unlist(gene.list) %in% colnames(df.gene.CNDR)]
r.gene.vuln <- lapply(gene.list, function(g) cor.test(df.vuln$v,df.gene.CNDR[,g],use = 'pairwise.complete.obs',method ='spearman'))
r.gene.vuln.r <- sapply(r.gene.vuln, function(X) unname(X$estimate))
r.gene.vuln.p <- sapply(r.gene.vuln, function(X) unname(X$p.value))
r.gene.vuln.p.bonf <- p.adjust(r.gene.vuln.p,method='bonf')
r.gene.vuln.p.fdr <- p.adjust(r.gene.vuln.p,method = 'fdr')

ord <- order(abs(r.gene.vuln.r),decreasing = T)

df.res <- data.frame(r=r.gene.vuln.r[ord],p_un=r.gene.vuln.p[ord],p_bonf=r.gene.vuln.p.bonf[ord],p_fdr=r.gene.vuln.p.fdr[ord])
write.csv(x=df.res,file = paste0(savedir,grp,'OteroGarciaGenes.csv'))

p.list <- lapply(gene.list, function(g) p.xy.flex(x=df.gene.CNDR[,g],y=df.vuln$v,xlab = g,ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
                                             ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res[g,'p_fdr'],pos = 'top.right',r.method = 'spearman'))
p.all <- plot_grid(plotlist = p.list,ncol=7,nrow=3)
ggsave(p.all,filename = paste(savedir,grp,'OteroGarciaGenesFDRSpearman.pdf',sep=''),
       units = 'cm',height = 9,width = 18,useDingbats=FALSE)

##############################
### PCA of gene expression ###
##############################

X <- df.gene.CNDR[setdiff(rownames(df.gene.CNDR),'ZI'),unname(unlist(gene.list))]
X <- X[,colSums(is.na(X))==0]
for(j in 1:ncol(X)){X[,j] <- X[,j] - mean(X[,j])} # center every variable in X
pca <- prcomp(X)
pca$scores <- X %*% pca$rotation[,drop=F]
r.pc.vuln <- lapply(colnames(pca$scores), function(g) cor.test(df.vuln[setdiff(rownames(df.gene.CNDR),'ZI'),'v'],pca$scores[,g],method='spearman'))
r.pc.vuln.r <- sapply(r.pc.vuln, function(X) unname(X$estimate))
r.pc.vuln.p <- p.adjust(sapply(r.pc.vuln, function(X) unname(X$p.value)),method='fdr')
