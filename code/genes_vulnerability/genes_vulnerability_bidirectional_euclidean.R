# this script uses vulnerability obtained from optim_bidirectional_euclidean_onelm.R model that fits
# a model with anterograde, retrograde, and euclidean distance matrix diffusion models
# then compares vulnerability to gene expression, and also compares vulnerability between the triple matrix
# model and the bidirectional connectivity model.

#################
### Load data ###
#################

rm(list=setdiff(ls(),c('params','grp','injection.site')))
print(grp)
basedir <- params$basedir
setwd(basedir)
savedir <- paste(params$opdir,'genes_vulnerability_bde/',paste0(injection.site,collapse='-'),'/',sep='')
dir.create(savedir,recursive=T)

source('code/misc/fitfxns.R')
source('code/misc/optimfxns.R')
source('code/misc/miscfxns.R')
source('code/misc/plottingfxns.R')
source('code/misc/normfuns.R')

load(paste(params$opdir,'processed/pathdata.RData',sep=''))  # load path data and ROI names

r.method <- 'pearson' # set method for correlation

##########################
### load vulnerability ###
##########################

vuln.dir <- paste(params$opdir,'diffmodel/bidirectional_euclidean_onelm/',paste0(injection.site,collapse='-'),'/',sep='')
# compute intrinsic vulnerability as an average over time and hemispheres
tp.excl <- '1 MPI' # exclude 1 MPI - see diffmodel/vuln_hemi_time.R
load(paste0(vuln.dir,grp,'vulnerability_bidirectional_euclidean_hemiaverage_exclude',tp.excl,'.RData'))
df.vuln <- hemi.average.vuln

#################################
### load gene expression data ###
#################################

df.gene <- read.csv('data/aba/expression/AllGeneExpression_Fulcher2019.csv',row.names = 1)

# convert hemisphere averaged gene expression to CNDR space
rownames(df.gene) <- paste0('i',rownames(df.gene)) # add i so mapping function works
df.gene.CNDR <- map.ABA.to.CNDR(df.gene,path.names,ABA.to.CNDR.key)
df.gene.CNDR <- df.gene.CNDR[paste0('i',rownames(df.vuln)),] # remove contra regions which are all na and order like vulnerability
rownames(df.gene.CNDR) <- substr(rownames(df.gene.CNDR),2,nchar(rownames(df.gene.CNDR))) # remove i from names

# r.mat <- cor(df.gene.CNDR,use='pairwise.complete.obs',method = r.method)
# hc <- hclust(as.dist(1-r.mat))
# image(r.mat[hc$order,hc$order])

#df.gene.CNDR <- df.gene.CNDR[,-which(colSums(is.na(df.gene.CNDR)) > 0.1*nrow(df.gene.CNDR))]
gene.names <- colnames(df.gene.CNDR)
names(gene.names) <- gene.names
region.names.gene <- rownames(df.gene.CNDR)

# normalize gene expression and vulnerability data using rank inverse normal transformation -- https://www.nature.com/articles/ejhg2015270
df.gene.CNDR <- rank_INT(df.gene.CNDR)
df.vuln <- rank_INT(df.vuln)

##############################
### PCA of gene expression ###
##############################

X <- df.gene.CNDR[setdiff(rownames(df.gene.CNDR),'ZI'),]
X <- X[,colSums(is.na(X))==0]
for(j in 1:ncol(X)){X[,j] <- X[,j] - mean(X[,j])} # center every variable in X
pca <- prcomp(X)
pca$scores <- X %*% pca$rotation[,drop=F]
r.pc.vuln <- lapply(colnames(pca$scores), function(g) cor.test(df.vuln[setdiff(rownames(df.gene.CNDR),'ZI'),'v'],pca$scores[,g],method=r.method))
r.pc.vuln.r <- sapply(r.pc.vuln, function(X) unname(X$estimate))
r.pc.vuln.p <- p.adjust(sapply(r.pc.vuln, function(X) unname(X$p.value)))

####################################################################
### simple correlation between gene expression and vulnerability ###
####################################################################

r.gene.vuln <- lapply(gene.names, function(g) cor.test(df.vuln$v,df.gene.CNDR[,g],
                                                       use = 'pairwise.complete.obs',
                                                       method =r.method))
r.gene.vuln.r <- sapply(r.gene.vuln, function(X) unname(X$estimate))
r.gene.vuln.p <- sapply(r.gene.vuln, function(X) unname(X$p.value))

r.gene.vuln.p.bonf <- p.adjust(r.gene.vuln.p,method='bonferroni')
r.gene.vuln.p.fdr <- p.adjust(r.gene.vuln.p,method = 'fdr')

ord <- order(abs(r.gene.vuln.r),decreasing = T)

n <- 100
df.res <- data.frame(r=r.gene.vuln.r[ord][1:n],p_bonf=r.gene.vuln.p.bonf[ord][1:n],p_fdr=r.gene.vuln.p.fdr[ord][1:n],p_un=r.gene.vuln.p[ord][1:n])
write.csv(x=df.res,file = paste0(savedir,grp,'Top',n,'GenesVulnerability',r.method,'.csv'))

genes.vuln.related <- names(r.gene.vuln.r)[r.gene.vuln.p.fdr<0.05]
if(length(genes.vuln.related)>0){
  gene.r.mat <- cor(df.gene.CNDR[,genes.vuln.related],use = 'pairwise.complete.obs',method = 'pearson')
  hc <- hclust(as.dist(1-gene.r.mat)) # simple hierarchical clustering to group genes by similarity
  p <- imagesc(gene.r.mat[hc$order,hc$order],cmap = 'BrBG',clim = c(-1,1),caxis_name = 'r') + coord_equal()+ 
    theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1)) +
    ggtitle('Spatial Similarity of Expression Patterns\nFor Vulnerability-Related Genes') + theme(plot.title = element_text(hjust=0.5)) +
    nice_cbar()
  ggsave(p,filename = paste0(savedir,grp,'SimilarityOfVulnerabilityRelatedGenes',r.method,'.pdf'),
         units = 'cm',height = 6,width = 6,useDingbats=FALSE)
}

p.list <- lapply(genes.vuln.related, function(g) p.xy.flex(x=df.gene.CNDR[,g],y=df.vuln$v,
                                                           xlab = g,ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
                                                  ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res[g,'p_fdr'],pos = 'top.right',r.method = r.method))
p.all <- plot_grid(plotlist = p.list,ncol=7,nrow=3)
ggsave(p.all,filename = paste(savedir,grp,'VulnerabilityRelatedGenesFDR',r.method,'.pdf',sep=''),
       units = 'cm',height = 9,width = 18,useDingbats=FALSE)

## compare gene hits between bidirectional and bidirectional euclidean model
df.res.bd <- read.csv(file = paste0(params$opdir,'genes_vulnerability/',
                                    paste0(injection.site,collapse='-'),'/',grp,'Top',n,'GenesVulnerability',
                                    r.method,'.csv'),row.names = 1)

sig.genes.bd <- rownames(df.res.bd)[df.res.bd$p_fdr<0.05]
df.res.bd[sig.genes.bd,'r']
p.r.bd.bde <- p.xy.flex(x=df.res.bd[sig.genes.bd,'r'],y=df.res[sig.genes.bd,'r'],
          ylab = 'Bidirectional + Euclidean\nPearson\'s r(gene,vulnerability)',
          xlab = 'Bidirectional \nPearson\'s r(gene,vulnerability)',ln.sz = 0,alpha=0.5) + geom_abline(linetype='dashed')

p.p.bd.bde <- p.xy.flex(x=log(df.res.bd[sig.genes.bd,'p_un'],base=10),y=log(df.res[sig.genes.bd,'p_un'],base=10),
                        ylab = 'Bidirectional + Euclidean\nPearson\'s r(gene,vulnerability)\nlog-10 p-value',
                        xlab = 'Bidirectional \nPearson\'s r(gene,vulnerability)\nlog-10 p-value',ln.sz = 0,alpha=0.5) + geom_abline(linetype='dashed')

# compare vulnerability between bidirectional and bidirectional euclidean model
df.vuln.bd <- read.csv(paste0(params$opdir,'diffmodel/bidirectional_onelm/',paste0(injection.site,collapse='-'),'/',
                              grp,'vulnerability_bidirectional_hemiaverage_exclude',tp.excl,'.csv'),row.names = 1)
p.vuln.bd.bde <- p.xy.flex(rank_INT(df.vuln.bd$v),rank_INT(df.vuln$v),xlab = 'Bidirectional Vulnerability',ylab = 'Bidirectional + Euclidean Vulnerability',
               alpha = 0.5,ln.sz = 0.5,ttl='')

p.all <- plot_grid(plotlist = list(p.vuln.bd.bde,p.r.bd.bde,p.p.bd.bde),align='hv',nrow=1)
ggsave(p.all,filename = paste(savedir,grp,'VulnerabilityGeneHitsBidirectionalvsBD+Euclidean',r.method,'.pdf',sep=''),
       units = 'cm',height = 6,width = 18,useDingbats=FALSE)

